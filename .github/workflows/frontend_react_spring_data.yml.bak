# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: frontend-react-spring-data-cicd

on:
  workflow_dispatch:

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: '1.8'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -B package --file pom.xml
      
    - uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_SERVER }}
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - run: |
        docker build . -t ${{ secrets.ACR_SERVER }}/frontend-react-spring:${{ github.sha }}
        docker push ${{ secrets.ACR_SERVER }}/frontend-react-spring:${{ github.sha }}
        
#############################################################
# Deploy to Dev
#############################################################
  Dev:
    needs: Build
    runs-on: ubuntu-latest
    env:
      resourceGroupName: '${{ secrets.Dev_RESOURCE_GROUP }}'
      clustername: '${{ secrets.DEV_CLUSTER_NAME }}'
      
    steps:
      - uses: actions/checkout@main
      
      - uses: azure/setup-kubectl@v2.0

      # Set the target AKS cluster.
      - uses: Azure/aks-set-context@v1
        with:
          creds: "${{ secrets.DEV_AZURE_CREDENTIALS }}"
          cluster-name: "${{ env.clustername }}"
          resource-group: "${{ env.resourceGroupName }}"

      - uses: Azure/k8s-create-secret@v1.1
        with:
          container-registry-url: ${{ secrets.ACR_SERVER }}
          container-registry-username: ${{ secrets.REGISTRY_USERNAME }}
          container-registry-password: ${{ secrets.REGISTRY_PASSWORD }}
          secret-name: reactspring-k8s-secret

      - uses: Azure/k8s-deploy@v1.4
        with:
          action: deploy
          manifests: |
            ${{ github.workspace }}/manifests/frontend/ns.yaml
            ${{ github.workspace }}/manifests/frontend/deployment.yaml
            ${{ github.workspace }}/manifests/frontend/svc.yaml
          images: |
             ${{ secrets.ACR_SERVER }}/frontend-react-spring:${{ github.sha }}
          imagepullsecrets: |
            reactspring-k8s-secret
 
